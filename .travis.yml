sudo: required
language: generic
env:
  global:
    - ORG="devonfw"
    - EMAIL="icsddevonfwsupport.apps2@capgemini.com"
    - REPO_SOURCE="my-thai-star"
    - REPO_DEST="my-thai-star.wiki"
    - REPO_CONSOLIDATE="devonfw-guide"
    - GH_REPO_SOURCE="github.com/${ORG}/${REPO_SOURCE}.git"
    - GH_REPO_DEST="github.com/${ORG}/${REPO_DEST}.git"
    - GH_REPO_CONSOLIDATE="github.com/${ORG}/${REPO_CONSOLIDATE}.git"
    - secure: iiNcQTmnDnPlGsI34mjOJ/RdVnIwUCo8MgL59aWuawZiNZDXJ+TxG/ZQHGFe6K5ZR6BW6J6MPbw4v2+HIC0qzuiAjT6RZVbkGMduGauchY4oqiSaCPMc9oerr5k1hIDr2QwwrROLgMSP4RVFmO8EtlflK0OV48QGdCSrho6QbEK4erPbbgHxouY8xE1F7bx/xb2k68Y6YawewTJN2vwCsjn1E99r7QvAkZ/BvS1+uXj2iSBw8IHCPXcKItOSjNc72TqR5eLmPPjyOb4hKa7Ymd7uoQK0M6up9sY+p32SvOnWLepKtPv4524ipAY9zKa4s+n71X/d5nNIZ6Q/3hm7pZP9NXC+iLTopMfoa2CDID98fSP62PPkOZquytGfzRXeq3R3mLFZlKywPB7OLhJ5edOhm/1AVWt++/N72GaAV+gvBn7xwfrI/227wM4HapGNyNgckXdz2oTsHuziBmJfyHavJOf3Pm6fQhLlQB36eHo+5Zg6rDu7RvYBZZDWyzatUw5s2hR6PFieTxW7Cq5AHqDs2UVQ4PAktI5eTZpb6YvDobJB3QG8r1hYgcGcn4t91w+FJrIuVZDwGWPRJrVwRMwLPvtLT+RuQu8OEajTGhrITl05+bOTRT+hD/TkioIIjpt/ofVQWOZKz3in3g4r4YG3VHyBkmBxHhcDhxyCJZA=
stages:
  - name: Docker
    if: branch = develop
  - name: Documentation
    if: (branch = develop) AND (type = push)
jobs:
  include:
    - stage: Docker
      script:
        - docker build -f angular/Dockerfile.travis -t my-thai-star-angular angular/.
        - docker build -f java/Dockerfile.travis -t my-thai-star-java java/.
    - stage: Documentation
      script:
        # Clone repositories
        - git clone -b develop --single-branch https://${GH_REPO_SOURCE}
        - git clone https://${GH_REPO_DEST}
        - git clone https://${GH_REPO_CONSOLIDATE}
        # Update wiki repository with documentation folder contents
        - yes | cp -rf ${REPO_SOURCE}/documentation/* ${REPO_DEST}/
        - cd ${REPO_DEST}
        # Terminate Travis CI build when no changes detected
        - if git diff-index --quiet HEAD && [ ! -n "$(git status -s)" ]; then set +e; pkill -9 -P $$ &> /dev/null || true; exit 0; fi;
        - git config user.email ${EMAIL}
        - git config user.name ${USER}
        - git status
        - git add .
        - git commit -m "${REPO_SOURCE} documentation | Travis CI build number $TRAVIS_BUILD_NUMBER"
        - git remote add origin-wiki "https://${USER}:${GITHUB_TOKEN}@${GH_REPO_DEST}"
        - git push origin-wiki master
        # Update consolidated repo
        - cd ../${REPO_CONSOLIDATE}
        - if [ ! -d ${REPO_DEST} ]; then git submodule add https://${GH_REPO_DEST}; else return 0; fi;
        - git submodule init
        - git submodule update
        - cd ${REPO_DEST}
        - git checkout master
        - git pull
        - cd ..
        - git add .
        - git commit -m "${REPO_SOURCE} documentation | Travis CI build number $TRAVIS_BUILD_NUMBER"
        - git remote add origin-wiki "https://${USER}:${GITHUB_TOKEN}@${GH_REPO_CONSOLIDATE}"
        - git push origin-wiki master
